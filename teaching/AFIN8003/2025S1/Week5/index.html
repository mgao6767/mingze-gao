<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dr.&nbsp;Mingze Gao (MQBS) and David Chan (ASX)">
<meta name="dcterms.date" content="2025-03-27">

<title>AFIN8003 Week 5 - Market Risk ‚Äì Mingze Gao</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../../images/favicon.png" rel="icon" type="image/png">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting-de84f8d6bb715db06a919283c2d1e787.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap-17cf1aa965d7a3061eaf472c0fafa655.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-1QDTTQ6EHM"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-1QDTTQ6EHM', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../../styles.css">
<meta name="twitter:title" content="AFIN8003 Week 5 - Market Risk ‚Äì Mingze Gao">
<meta name="twitter:description" content="Banking and Financial Intermediation">
<meta name="twitter:image" content="https://mingze-gao.com/teaching/AFIN8003/2025S1/Week5/figures/fig-trading-book-market-risk.png">
<meta name="twitter:image-height" content="929">
<meta name="twitter:image-width" content="1390">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../../images/favicon.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../posts/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../teaching/index.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://phds.io/"> 
<span class="menu-text">Literature üîç</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#guest-lecturer" id="toc-guest-lecturer" class="nav-link active" data-scroll-target="#guest-lecturer">Guest lecturer</a>
  <ul class="collapse">
  <li><a href="#david-chan" id="toc-david-chan" class="nav-link" data-scroll-target="#david-chan">David Chan</a></li>
  </ul></li>
  <li><a href="#market-risk" id="toc-market-risk" class="nav-link" data-scroll-target="#market-risk">Market risk</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#introduction-contd" id="toc-introduction-contd" class="nav-link" data-scroll-target="#introduction-contd">Introduction (cont‚Äôd)</a></li>
  <li><a href="#market-risk-exposure" id="toc-market-risk-exposure" class="nav-link" data-scroll-target="#market-risk-exposure">Market risk exposure</a></li>
  </ul></li>
  <li><a href="#value-at-risk-var" id="toc-value-at-risk-var" class="nav-link" data-scroll-target="#value-at-risk-var">Value at Risk (VaR)</a>
  <ul class="collapse">
  <li><a href="#concept-of-var" id="toc-concept-of-var" class="nav-link" data-scroll-target="#concept-of-var">Concept of VaR</a></li>
  <li><a href="#another-example-of-var" id="toc-another-example-of-var" class="nav-link" data-scroll-target="#another-example-of-var">Another example of VaR</a></li>
  <li><a href="#models-for-computing-var" id="toc-models-for-computing-var" class="nav-link" data-scroll-target="#models-for-computing-var">Models for computing VaR</a></li>
  <li><a href="#var-riskmetrics" id="toc-var-riskmetrics" class="nav-link" data-scroll-target="#var-riskmetrics">VaR: RiskMetrics</a></li>
  <li><a href="#var-riskmetrics-contd" id="toc-var-riskmetrics-contd" class="nav-link" data-scroll-target="#var-riskmetrics-contd">VaR: RiskMetrics (cont‚Äôd)</a></li>
  <li><a href="#var-riskmetrics-contd-1" id="toc-var-riskmetrics-contd-1" class="nav-link" data-scroll-target="#var-riskmetrics-contd-1">VaR: RiskMetrics (cont‚Äôd)</a></li>
  <li><a href="#var-riskmetrics-for-fixed-income-securities" id="toc-var-riskmetrics-for-fixed-income-securities" class="nav-link" data-scroll-target="#var-riskmetrics-for-fixed-income-securities">VaR: RiskMetrics for fixed-income securities</a></li>
  <li><a href="#var-riskmetrics-for-fixed-income-securities-contd" id="toc-var-riskmetrics-for-fixed-income-securities-contd" class="nav-link" data-scroll-target="#var-riskmetrics-for-fixed-income-securities-contd">VaR: RiskMetrics for fixed-income securities (cont‚Äôd)</a></li>
  <li><a href="#var-riskmetrics-for-fixed-income-securities-contd-1" id="toc-var-riskmetrics-for-fixed-income-securities-contd-1" class="nav-link" data-scroll-target="#var-riskmetrics-for-fixed-income-securities-contd-1">VaR: RiskMetrics for fixed-income securities (cont‚Äôd)</a></li>
  <li><a href="#var-riskmetrics-for-fixed-income-securities-contd-2" id="toc-var-riskmetrics-for-fixed-income-securities-contd-2" class="nav-link" data-scroll-target="#var-riskmetrics-for-fixed-income-securities-contd-2">VaR: RiskMetrics for fixed-income securities (cont‚Äôd)</a></li>
  <li><a href="#var-riskmetrics-for-fx" id="toc-var-riskmetrics-for-fx" class="nav-link" data-scroll-target="#var-riskmetrics-for-fx">VaR: RiskMetrics for FX</a></li>
  <li><a href="#var-riskmetrics-for-equities" id="toc-var-riskmetrics-for-equities" class="nav-link" data-scroll-target="#var-riskmetrics-for-equities">VaR: RiskMetrics for equities</a></li>
  <li><a href="#var-riskmetrics-for-equities-contd" id="toc-var-riskmetrics-for-equities-contd" class="nav-link" data-scroll-target="#var-riskmetrics-for-equities-contd">VaR: RiskMetrics for equities (cont‚Äôd)</a></li>
  <li><a href="#var-portfolio-aggregation" id="toc-var-portfolio-aggregation" class="nav-link" data-scroll-target="#var-portfolio-aggregation">VaR: portfolio aggregation</a></li>
  <li><a href="#var-portfolio-aggregation-contd" id="toc-var-portfolio-aggregation-contd" class="nav-link" data-scroll-target="#var-portfolio-aggregation-contd">VaR: portfolio aggregation (cont‚Äôd)</a></li>
  <li><a href="#var-portfolio-aggregation-contd-1" id="toc-var-portfolio-aggregation-contd-1" class="nav-link" data-scroll-target="#var-portfolio-aggregation-contd-1">VaR: portfolio aggregation (cont‚Äôd)</a></li>
  <li><a href="#var-criticisms-against-riskmetrics" id="toc-var-criticisms-against-riskmetrics" class="nav-link" data-scroll-target="#var-criticisms-against-riskmetrics">VaR: criticisms against RiskMetrics</a></li>
  <li><a href="#var-historic-or-back-simulation" id="toc-var-historic-or-back-simulation" class="nav-link" data-scroll-target="#var-historic-or-back-simulation">VaR: historic or back simulation</a></li>
  <li><a href="#var-historic-or-back-simulation-contd" id="toc-var-historic-or-back-simulation-contd" class="nav-link" data-scroll-target="#var-historic-or-back-simulation-contd">VaR: historic or back simulation (cont‚Äôd)</a></li>
  <li><a href="#var-monte-carlo-simulation" id="toc-var-monte-carlo-simulation" class="nav-link" data-scroll-target="#var-monte-carlo-simulation">VaR: Monte Carlo simulation</a></li>
  <li><a href="#var-monte-carlo-simulation-contd" id="toc-var-monte-carlo-simulation-contd" class="nav-link" data-scroll-target="#var-monte-carlo-simulation-contd">VaR: Monte Carlo simulation (cont‚Äôd)</a></li>
  <li><a href="#var-monte-carlo-simulation-contd-1" id="toc-var-monte-carlo-simulation-contd-1" class="nav-link" data-scroll-target="#var-monte-carlo-simulation-contd-1">VaR: Monte Carlo simulation (cont‚Äôd)</a></li>
  <li><a href="#var-monte-carlo-simulation-example" id="toc-var-monte-carlo-simulation-example" class="nav-link" data-scroll-target="#var-monte-carlo-simulation-example">VaR: Monte Carlo simulation (example)</a></li>
  </ul></li>
  <li><a href="#expected-shortfall-es" id="toc-expected-shortfall-es" class="nav-link" data-scroll-target="#expected-shortfall-es">Expected Shortfall (ES)</a>
  <ul class="collapse">
  <li><a href="#why-var-could-be-misleading" id="toc-why-var-could-be-misleading" class="nav-link" data-scroll-target="#why-var-could-be-misleading">Why VaR could be misleading?</a></li>
  <li><a href="#es-conditional-var" id="toc-es-conditional-var" class="nav-link" data-scroll-target="#es-conditional-var">ES: conditional VaR</a></li>
  <li><a href="#es-definition" id="toc-es-definition" class="nav-link" data-scroll-target="#es-definition">ES: definition</a></li>
  <li><a href="#es-advantages-and-potential-problems" id="toc-es-advantages-and-potential-problems" class="nav-link" data-scroll-target="#es-advantages-and-potential-problems">ES: advantages and (potential) problems</a></li>
  </ul></li>
  <li><a href="#bis-regulatory-models" id="toc-bis-regulatory-models" class="nav-link" data-scroll-target="#bis-regulatory-models">BIS regulatory models</a>
  <ul class="collapse">
  <li><a href="#bis-regulatory-models-1" id="toc-bis-regulatory-models-1" class="nav-link" data-scroll-target="#bis-regulatory-models-1">BIS regulatory models</a></li>
  <li><a href="#basel-iii-and-its-implementation" id="toc-basel-iii-and-its-implementation" class="nav-link" data-scroll-target="#basel-iii-and-its-implementation">Basel III and its implementation</a></li>
  <li><a href="#regulatory-model-standardized-framework" id="toc-regulatory-model-standardized-framework" class="nav-link" data-scroll-target="#regulatory-model-standardized-framework">Regulatory model: standardized framework</a></li>
  <li><a href="#regulatory-model-ima" id="toc-regulatory-model-ima" class="nav-link" data-scroll-target="#regulatory-model-ima">Regulatory model: IMA</a></li>
  </ul></li>
  <li><a href="#finally" id="toc-finally" class="nav-link" data-scroll-target="#finally">Finally‚Ä¶</a>
  <ul class="collapse">
  <li><a href="#suggested-readings" id="toc-suggested-readings" class="nav-link" data-scroll-target="#suggested-readings">Suggested readings</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="index.html"><i class="bi bi-file-slides"></i>RevealJS (mq)</a></li><li><a href="Week5.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">AFIN8003 Week 5 - Market Risk</h1>
<p class="subtitle lead">Banking and Financial Intermediation</p>
  <div class="quarto-categories">
    <div class="quarto-category">AFIN8003</div>
    <div class="quarto-category">2025S1</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dr.&nbsp;Mingze Gao (MQBS) and David Chan (ASX) </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 27, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="guest-lecturer" class="level1">
<h1>Guest lecturer</h1>
<section id="david-chan" class="level2">
<h2 class="anchored" data-anchor-id="david-chan">David Chan</h2>
<p>David Chan has over 25 years‚Äô experience in financial markets and is currently at ASX as <strong>Senior Manager Clearing Risk Data Analytics &amp; Framework</strong>. In this role, David is responsible for the development of data &amp; risk analytics platform, clearing risk management monitoring &amp; review framework.</p>
<p>Prior to joining ASX, David was <strong>Executive Manager Strategic Risk Oversight</strong> at Commonwealth Bank of Australia, with responsibility for oversight trading book for Global Markets. In this role, David covered a range of asset classes including FX, rates, equities, and commodities with a special focus on XVA portfolio and capital optimization.</p>
<p>Prior to working at Commonwealth Bank, David held a number of senior risk management, finance and operations roles at Agricultural Bank of China International, Mirae Asset and JP Morgan in Hong Kong and Sydney.</p>
<p>David‚Äôs expertise across sell side and buy side trading, treasury management, asset management, financing and prime brokerage. With strong interest in financial products and hedge strategies, portfolio management &amp; optimization, forecasting and predictive analysis, unauthorised trading oversight.</p>
<p>David holds a Bachelor‚Äôs degree in Computing Studies from Hong Kong Polytechnic University and a Master of Applied Finance from the University of Melbourne.</p>
</section>
</section>
<section id="market-risk" class="level1">
<h1>Market risk</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In last week, we discussed <a href="https://mingze-gao.com/teaching/AFIN8003/2025S1/Week4/">interest rate risk</a>: changes in interest rates could affect a FI‚Äôs income and net worth.</p>
<ul>
<li>Interest rate changes affect <em>mostly</em> the <strong>banking book</strong>.</li>
<li>The <strong>trading book</strong> is exposed to <strong>market risk</strong>.</li>
</ul>
<table class="table">
<colgroup>
<col style="width: 24%">
<col style="width: 47%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>Assets</th>
<th>Liabilities</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Banking book</strong></td>
<td>Cash</td>
<td>Deposits</td>
</tr>
<tr class="even">
<td></td>
<td>Loans</td>
<td>Other liabilities</td>
</tr>
<tr class="odd">
<td></td>
<td>Other assets</td>
<td>Capital</td>
</tr>
<tr class="even">
<td><strong>Trading book</strong></td>
<td>Bonds (long)</td>
<td>Bonds (short)</td>
</tr>
<tr class="odd">
<td></td>
<td>Commodities (long)</td>
<td>Commodities (short)</td>
</tr>
<tr class="even">
<td></td>
<td>FX (long)</td>
<td>FX (short)</td>
</tr>
<tr class="odd">
<td></td>
<td>Equities (long)</td>
<td>Equities (short)</td>
</tr>
<tr class="even">
<td></td>
<td>Mortgage-backed securities (long)</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Derivatives<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> (long)</td>
<td>Derivatives (short)</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled" title="Market Risk">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Market Risk
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Market risk</strong> is uncertainty of an FI‚Äôs earnings on its trading portfolio caused by changes, particularly extreme changes, in market conditions such as the price of an asset, interest rates, market volatility, and market liquidity.</p>
</div>
</div>
</section>
<section id="introduction-contd" class="level2">
<h2 class="anchored" data-anchor-id="introduction-contd">Introduction (cont‚Äôd)</h2>
<p>Intuitively, trading book includes assets, liabilities and derivatives that are actively traded in some financial markets and hence exposed to uncertainties of these markets.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./figures/fig-trading-book-market-risk.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="market-risk-exposure" class="level2">
<h2 class="anchored" data-anchor-id="market-risk-exposure">Market risk exposure</h2>
<p>FIs are concerned about the potential impact of changing market conditions on their trading book and ultimately their net worth and solvency.</p>
<p>A natural question becomes:</p>
<blockquote class="blockquote">
<p>How to quantify such impact? What is the <strong>potential change in value</strong> of trading portfolio for a given period?</p>
</blockquote>
<p>More specifically,</p>
<ol type="1">
<li>What is the worst loss we can expect not to exceed with a given confidence level over a specific time horizon?</li>
<li>What is the expected loss when losses exceed a certain level over a specific time horizon?</li>
</ol>
<p>Answering these questions leads to the development of two important concepts for measuring market risk exposure:</p>
<ol type="1">
<li>Value at Risk (VaR).</li>
<li>Expected Shortfall (ES).</li>
</ol>
<p>We start with the concept of Value at Risk (VaR), then discuss its limitations and the use of Expected Shortfall (ES).</p>
</section>
</section>
<section id="value-at-risk-var" class="level1 page-columns page-full">
<h1>Value at Risk (VaR)</h1>
<section id="concept-of-var" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="concept-of-var">Concept of VaR</h2>
<p>Suppose we know the distribution of an asset‚Äôs returns over a specific period (in the future), then for a given confidence level <span class="math inline">\(c\in[0,1]\)</span> (e.g., <span class="math inline">\(c=0.95\)</span>), we can partition the distribution into two parts: one (in red) that represents a proportion of <span class="math inline">\((1-c)\)</span> of the distribution and the other (in blue) accounting the remaining <span class="math inline">\(c\)</span> proportion.</p>
<div class="columns page-columns page-full">
<div class="column page-columns page-full">
<div id="cell-fig-returns-VaR" class="cell page-columns page-full" data-fig-location="center" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for reproducibility</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Mean of returns</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> <span class="fl">0.01</span>  <span class="co"># Standard deviation of returns</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10000</span>  <span class="co"># Number of simulations</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>confidence_level <span class="op">=</span> <span class="fl">0.95</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate returns</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> np.random.normal(mu, sigma, n)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate VaR</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>VaR <span class="op">=</span> np.percentile(returns, (<span class="dv">1</span> <span class="op">-</span> confidence_level) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram with different colors for bars below and above VaR</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram data</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>n, bins, patches <span class="op">=</span> plt.hist(returns, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, edgecolor<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Change color of bars</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(patches)):</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bins[i] <span class="op">&lt;</span> VaR:</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        patches[i].set_facecolor(<span class="st">"#A6192E"</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        patches[i].set_facecolor(<span class="st">"#D6D2C4"</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Add VaR line</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>plt.axvline(VaR, color<span class="op">=</span><span class="st">"#A6192E"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Simulated Distribution of Returns with VaR"</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Return"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"VaR at 95%"</span>, <span class="st">"Returns"</span>])</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-returns-var" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-returns-var-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-returns-var-output-1.png" width="816" height="523" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-returns-var-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Distribution of expected returns and VaR
</figcaption>
</figure>
</div>
</div>
</div>
</div><div class="column">
<p>Therefore, the cutoff value of returns that separates the two parts defines:</p>
<ul>
<li>a minimum return that we are confident 95% of the time, or</li>
<li><strong>a maximum loss that we are confident 95% of the time</strong>.</li>
</ul>
</div>
</div>
</section>
<section id="another-example-of-var" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="another-example-of-var">Another example of VaR</h2>
<p>This VaR concept does not depend on the shape of return distribution.</p>
<p>For example, below we have an interestingly shaped return distribution. Given a confidence level of 99%, we can find the 99% VaR.</p>
<div id="cell-fig-returns-VaR-example-2" class="cell page-columns page-full" data-fig-location="center" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate returns with a non-normal distribution (e.g., bimodal distribution)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for bimodal distribution</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>mu1, sigma1, weight1 <span class="op">=</span> <span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.5</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>mu2, sigma2, weight2 <span class="op">=</span> <span class="fl">0.03</span>, <span class="fl">0.02</span>, <span class="fl">0.5</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate bimodal returns</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>returns1 <span class="op">=</span> np.random.normal(mu1, sigma1, <span class="bu">int</span>(n <span class="op">*</span> weight1))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>returns2 <span class="op">=</span> np.random.normal(mu2, sigma2, <span class="bu">int</span>(n <span class="op">*</span> weight2))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> np.concatenate([returns1, returns2])</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate VaR</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>confidence_level <span class="op">=</span> <span class="fl">0.99</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>VaR <span class="op">=</span> np.percentile(returns, (<span class="dv">1</span> <span class="op">-</span> confidence_level) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram with different colors for bars below and above VaR</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram data</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>n, bins, patches <span class="op">=</span> plt.hist(returns, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, edgecolor<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Change color of bars</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(patches)):</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bins[i] <span class="op">&lt;</span> VaR:</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        patches[i].set_facecolor(<span class="st">"#A6192E"</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        patches[i].set_facecolor(<span class="st">"#D6D2C4"</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Add VaR line</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>plt.axvline(VaR, color<span class="op">=</span><span class="st">"#A6192E"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Simulated Distribution of Returns with VaR (Non-Normal Distribution)"</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Return"</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"VaR at 99%"</span>, <span class="st">"Returns"</span>])</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-returns-var-example-2" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-returns-var-example-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-returns-var-example-2-output-1.png" width="816" height="523" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-returns-var-example-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Distribution of expected returns and VaR (another example)
</figcaption>
</figure>
</div>
</div>
</div>
<p>From the plot, we can say that 99% of the time, the asset‚Äôs return will be in the blue region, which means that it will not fall below the 99% VaR (recall that VaR is a cutoff value).</p>
</section>
<section id="models-for-computing-var" class="level2">
<h2 class="anchored" data-anchor-id="models-for-computing-var">Models for computing VaR</h2>
<p>Over the years, many models have been developed to compute VaR.</p>
<p>This is because we do not have the return distribution of trading portfolio over a specific period in the future.</p>
<ul>
<li>If we do, then VaR is unambiguous.</li>
</ul>
<p>Therefore, different assumptions lead to different models and approaches. We are interested in three in this course:</p>
<ol type="1">
<li>RiskMetrics (variance-covariance approach)</li>
<li>Historic or back simulation</li>
<li>Monte Carlo simulation</li>
</ol>
</section>
<section id="var-riskmetrics" class="level2">
<h2 class="anchored" data-anchor-id="var-riskmetrics">VaR: RiskMetrics</h2>
<blockquote class="blockquote">
<p>‚ÄúAt close of business each day tell me what the market risks are across all businesses and locations‚Äù</p>
<p>Sir Dennis Weatherstone, 1989, former chairman of J.P. Morgan &amp; Co., now JPMorgan Chase.</p>
</blockquote>
<div class="fragment">
<p>Managers at JPM needs to respond with <em>‚ÄúI am X% sure that the FI will not lose more than $VAR in the next T days.‚Äù</em></p>
<p>Basically, the FI manager wants a single dollar number that tells him or her the FI‚Äôs market risk exposure over the next days‚Äîespecially if those days turn out to be extremely ‚Äúbad‚Äù days.</p>
</div>
<div class="fragment">
<ul>
<li>A very difficult task given that in 1994, JPMorgan had 14 active trading locations with 120 independent units trading fixed-income securities, foreign exchange, commodities, derivatives, emerging-market securities, and proprietary assets.</li>
</ul>
</div>
<div class="fragment">
<ul>
<li>JPMorgan developed <strong>RiskMetrics</strong> model.</li>
</ul>
</div>
</section>
<section id="var-riskmetrics-contd" class="level2">
<h2 class="anchored" data-anchor-id="var-riskmetrics-contd">VaR: RiskMetrics (cont‚Äôd)</h2>
<p>In a nutshell, we are concerned about the market risk exposure on a daily basis. Market risk exposure over longer periods, under some assumptions, can be viewed as a simple transformation from the daily exposure.</p>
<p>The market risk is measured by the <strong>daily earnings at risk (DEAR)</strong>: <span class="math display">\[
\text{DEAR} = \left(\text{dollar market value of the position}\right) \times \left(\text{price sensitivity of the position}\right) \times \left(\text{potential adverse move}\right)
\]</span></p>
<p>Since price sensitivity multiplied by adverse move measures the degree of price volatility of an asset, we can write this equation as: <span class="math display">\[
\text{DEAR} = \left(\text{dollar market value of the position}\right) \times \left(\text{price volatility}\right)
\]</span></p>
<div class="callout callout-style-default callout-tip callout-titled" title="Dear DEAR and VaR">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Dear DEAR and VaR
</div>
</div>
<div class="callout-body-container callout-body">
<p>DEAR is basically 1-day dollar VaR in the context of RiskMetrics model.</p>
</div>
</div>
<div class="fragment">
<p>If we assume that shocks are independent, daily volatility is approximately constant, and that the FI holds this asset for <span class="math inline">\(N\)</span> number of days, then the <span class="math inline">\(N\)</span>-day VaR is related to DEAR by: <span class="math display">\[
N\text{-day VaR} = \left(\text{DEAR}\right) \times \sqrt{N}
\]</span></p>
</div>
</section>
<section id="var-riskmetrics-contd-1" class="level2">
<h2 class="anchored" data-anchor-id="var-riskmetrics-contd-1">VaR: RiskMetrics (cont‚Äôd)</h2>
<p>Next, we will apply RiskMetrics model on:</p>
<ol type="1">
<li>fixed-income securities</li>
<li>foreign exchange (FX)</li>
<li>equities</li>
</ol>
<p>Afterwards, we will study how to compute portfolio VaR.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recall that we need a single number across all asset classes for the aggregate market risk exposure. Aggregation is necessary.</p>
</div>
</div>
</section>
<section id="var-riskmetrics-for-fixed-income-securities" class="level2">
<h2 class="anchored" data-anchor-id="var-riskmetrics-for-fixed-income-securities">VaR: RiskMetrics for fixed-income securities</h2>
<p>Suppose an FI has a $1 million market value position in zero-coupon bonds of 7 years to maturity with a face value of $1,631,483. Today‚Äôs yield on these bonds is 7.243%.</p>
<blockquote class="blockquote">
<p>How to estimates its DEAR? Some additional assumptions are required.</p>
</blockquote>
<div class="fragment">
<p>Checking the formula: <span class="math display">\[
\text{DEAR} = \left(\text{dollar market value of the position}\right) \times \left(\text{price sensitivity of the position}\right) \times \left(\text{potential adverse move}\right)
\]</span></p>
</div>
<div class="fragment">
<p>Of these three components:</p>
<ul>
<li>dollar market value of the position is $1 million.</li>
<li>price sensitivity of bonds (w.r.t. yield) is measured by (modified) <strong>duration</strong> (recall last week‚Äôs material). <span class="math display">\[
MD = \frac{D}{1+R} = \frac{7}{1+0.07243} = 6.527
\]</span></li>
<li>potential adverse move (in yield) depends on <strong>the assumption of yield distribution</strong> and our chosen <strong>confidence level</strong>.</li>
</ul>
</div>
</section>
<section id="var-riskmetrics-for-fixed-income-securities-contd" class="level2">
<h2 class="anchored" data-anchor-id="var-riskmetrics-for-fixed-income-securities-contd">VaR: RiskMetrics for fixed-income securities (cont‚Äôd)</h2>
<p>In terms of the ‚Äúpotential adverse move in yield‚Äù, let‚Äôs assume we are concerned about bad yield changes such that there is only a 1% chance that the yield changes will exceed this amount.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>Note that bond prices decrease with yields. So, we want to know:</p>
<ul>
<li>the ‚Äúmaximum upward change in the 7-year rates‚Äù (over a day) with a 1% possibility.</li>
</ul>
<p>With RiskMetrics, we assume that changes in (7-year) yields follow a <a href="https://en.wikipedia.org/wiki/Normal_distribution">Normal distribution</a>. We further assume that<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<ul>
<li>the mean <span class="math inline">\(\mu\)</span> of daily changes in yield is 0bps.</li>
<li>the standard deviation <span class="math inline">\(\sigma\)</span> of daily changes in yield is 10bps.</li>
</ul>
</section>
<section id="var-riskmetrics-for-fixed-income-securities-contd-1" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="var-riskmetrics-for-fixed-income-securities-contd-1">VaR: RiskMetrics for fixed-income securities (cont‚Äôd)</h2>
<div class="columns page-columns page-full">
<div class="column page-columns page-full">
<p>Therefore, we can get distribution of daily changes in (7-year) yields as below.</p>
<div id="cell-fig-normal" class="cell page-columns page-full" data-fig-location="center" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for normal distribution</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> <span class="dv">0</span>  <span class="co"># mean</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> <span class="dv">10</span>  <span class="co"># standard deviation (10 bps)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(mu <span class="op">-</span> <span class="dv">4</span> <span class="op">*</span> sigma, mu <span class="op">+</span> <span class="dv">4</span> <span class="op">*</span> sigma, <span class="dv">1000</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> norm.pdf(x, mu, sigma)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the value at 2.33 standard deviations from the mean</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> mu <span class="op">+</span> <span class="fl">2.33</span> <span class="op">*</span> sigma</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot normal distribution</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>plt.plot(x, y, label<span class="op">=</span><span class="st">"Normal Distribution"</span>, color<span class="op">=</span><span class="st">"#D6D2C4"</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill the upper 1% area</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>x_fill <span class="op">=</span> np.linspace(threshold, mu <span class="op">+</span> <span class="dv">4</span> <span class="op">*</span> sigma, <span class="dv">100</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>y_fill <span class="op">=</span> norm.pdf(x_fill, mu, sigma)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>plt.fill_between(x_fill, y_fill, color<span class="op">=</span><span class="st">"#A6192E"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">"Upper 1% Area"</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark mean and threshold</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>plt.axvline(mu, color<span class="op">=</span><span class="st">"green"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Mean"</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>plt.axvline(</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    threshold, color<span class="op">=</span><span class="st">"orange"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"2.33 Std Dev"</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Normal Distribution with Mean and 2.33 Standard Deviation"</span>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Value (bps)"</span>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Probability Density"</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-normal" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-normal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-normal-output-1.png" width="829" height="523" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-normal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Normal distribution of changes in 7-year yields
</figcaption>
</figure>
</div>
</div>
</div>
</div><div class="column">
<p>The good mathematical property of normal distribution allows us to know that the upper 1% area is separated from the lower 99% by the value <span class="math inline">\(\mu+2.33\sigma\)</span>.</p>
<p>Since <span class="math inline">\(\mu=0\)</span> and <span class="math inline">\(\sigma=10\text{bps}\)</span>, the cutoff value is <span class="math inline">\(2.33\sigma=23.3\text{bps}\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>It means that, we are 99% confident that the maximum daily upward (adverse) change in (7-year) yields is 23.3 basis points (bps).</p>
</div>
</div>
</div>
</div>
</section>
<section id="var-riskmetrics-for-fixed-income-securities-contd-2" class="level2">
<h2 class="anchored" data-anchor-id="var-riskmetrics-for-fixed-income-securities-contd-2">VaR: RiskMetrics for fixed-income securities (cont‚Äôd)</h2>
<p>Now we can put everything together.</p>
<p><span class="math display">\[
\text{DEAR} = \left(\text{dollar market value of the position}\right) \times \left(\text{price sensitivity of the position}\right) \times \left(\text{potential adverse move}\right)
\]</span></p>
<p>Of these three components:</p>
<ul>
<li>dollar market value of the position is $1 million.</li>
<li>price sensitivity of bonds (w.r.t. yield) as measured by modified duration is 6.527.</li>
<li>potential adverse move (in yield) is 23.3bps or 0.00233%.</li>
</ul>
<p>So,</p>
<p><span class="math display">\[
\begin{aligned}
\text{DEAR} &amp;= \left(\text{dollar market value of the position}\right) \times \left(\text{price sensitivity of the position}\right) \times \left(\text{potential adverse move}\right) \\
&amp;= \$1,000,000 \times 6.527 \times 0.00233 \\
&amp;= \$15,207.91
\end{aligned}
\]</span></p>
<p>That is, the potential daily loss in earnings on the $1 million position is $15,207.91 if the 1 bad day in 100 occurs tomorrow.</p>
</section>
<section id="var-riskmetrics-for-fx" class="level2">
<h2 class="anchored" data-anchor-id="var-riskmetrics-for-fx">VaR: RiskMetrics for FX</h2>
<p>The method of DEAR calculation for FX is largely the same.</p>
<p><span class="math display">\[
\text{DEAR} = \left(\text{dollar market value of the position}\right) \times \left(\text{price volatility}\right)
\]</span></p>
<p>Suppose the FI had a ‚Ç¨800,000 trading position in spot euros at the close of business today. The current exchange rate is ‚Ç¨0.8/$1 (or $1.25/‚Ç¨1).</p>
<ul>
<li>Dollar market value of the position is <span class="math inline">\(‚Ç¨800,000 \times \$1.25/‚Ç¨1=\$1 \text{ million}\)</span>.</li>
<li>Suppose that we find the standard deviation of changes in daily exchange rate is 56.5bps, and mean change is 0.</li>
<li>Again with a 99% confidence level, the potential adverse move is <span class="math inline">\(2.33\times 56.5\text{bps}=131.645\text{bps}\)</span>.</li>
</ul>
<p>As a result,</p>
<p><span class="math display">\[
\begin{aligned}
\text{DEAR} &amp;= \left(\text{dollar market value of the position}\right) \times \left(\text{price volatility}\right) \\
&amp;= \$1,000,000 \times 0.0131645 \\
&amp;= \$13,164
\end{aligned}
\]</span></p>
<p>This is the potential daily earnings exposure to adverse euro to dollar exchange rate changes for the FI from the ‚Ç¨800,000 spot currency holdings.</p>
</section>
<section id="var-riskmetrics-for-equities" class="level2">
<h2 class="anchored" data-anchor-id="var-riskmetrics-for-equities">VaR: RiskMetrics for equities</h2>
<p>Fundamentally, there is nothing different when applying RiskMetrics DEAR on equity positions.</p>
<p>Recall that the Capital Market Pricing Model (CAPM) states that for an individual stock <span class="math inline">\(i\)</span>, its total risk is its systematic risk plus indiosyncratic (unsystematic) risk.</p>
<p><span class="math display">\[
\begin{aligned}
\text{Total risk} &amp;= \text{systematic risk} + \text{unsystematic risk} \\
\sigma^2_{it} &amp;= \beta^2_{i} \sigma^2_{mt} + \sigma^2_{eit}
\end{aligned}
\]</span></p>
<p>Systematic risk reflects the co-movement of that stock with the market portfolio reflected by the stock‚Äôs beta (<span class="math inline">\(\beta_i\)</span>) and the volatility of the market portfolio (<span class="math inline">\(\sigma_{mt}\)</span>), while unsystematic risk is specific to the firm itself (<span class="math inline">\(\sigma_{eit}\)</span>).</p>
<p>In a very well diversified portfolio, unsystematic risk can be largely diversified away (i.e., will equal zero), leaving behind systematic (undiversifiable) market risk.</p>
<p>If an FI‚Äôs equity portfolio largely replicate the market portfolio (index), its beta equals 1 and its standard deviation will be equal to the standard deviation of the market portfolio.</p>
</section>
<section id="var-riskmetrics-for-equities-contd" class="level2">
<h2 class="anchored" data-anchor-id="var-riskmetrics-for-equities-contd">VaR: RiskMetrics for equities (cont‚Äôd)</h2>
<p>Suppose the FI holds a $1 million equity portfolio that reflects a market index, then the DEAR of the portfolio is</p>
<p><span class="math display">\[
\begin{aligned}
\text{DEAR} &amp;= \left(\text{dollar market value of the position}\right) \times \left(\text{stock market return volatility}\right) \\
&amp;= \$1,000,000 \times 2.33\sigma_{m} \\
\end{aligned}
\]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, we‚Äôve assumed that the daily returns follow a normal distribution and the mean daily return is 0. Further, we‚Äôve assumed a 99% confidence level.</p>
</div>
</div>
<p>If we find that standard deviation of daily returns <span class="math inline">\(\sigma_m\)</span> is 200bps, then <span class="math inline">\(2.33\sigma_m=466\text{bps}\)</span>. This means that we believe that the adverse change in the daily returns of stock market could exceed 466bps only 1% of the time. As such,</p>
<p><span class="math display">\[
\begin{aligned}
\text{DEAR} &amp;= \left(\text{dollar market value of the position}\right) \times \left(\text{stock market return volatility}\right) \\
&amp;= \$1,000,000 \times 0.0466 \\
&amp;= \$46,600
\end{aligned}
\]</span></p>
<p>That is, the potential daily loss in earnings on the $1 million stock position is $46,600 if the 1 bad day in 100 occurs tomorrow.</p>
</section>
<section id="var-portfolio-aggregation" class="level2">
<h2 class="anchored" data-anchor-id="var-portfolio-aggregation">VaR: portfolio aggregation</h2>
<p>Now, we have calculated the individual DEAR for the three positions:</p>
<ol type="1">
<li>Seven-year, zero-coupon bonds = $15,207.91</li>
<li>Euro spot = $13,164</li>
<li>Equities = $46,600</li>
</ol>
<p>Yet the manager needs <em>a single number</em> aggregating all positions.</p>
<blockquote class="blockquote">
<p>Can we add up the individual DEARs and report it?</p>
</blockquote>
<div class="fragment">
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>NO. We cannot sum individual DEAR (or VaR) to compute the aggregate VaR.</p>
</div>
</div>
<p>If you recall, earlier when we introduce the difference models for calculating VaR, we mentioned that RiskMetrics is sometimes all called the ‚Äúvariance-covariance approach‚Äù.</p>
<ul>
<li>So far, we have only used the ‚Äúvariance‚Äù (standard deviation of potential changes), but not the ‚Äúcovariance‚Äù!</li>
<li>Asset shocks (adverse moves) very often are <em>correlated</em>.</li>
</ul>
</div>
</section>
<section id="var-portfolio-aggregation-contd" class="level2">
<h2 class="anchored" data-anchor-id="var-portfolio-aggregation-contd">VaR: portfolio aggregation (cont‚Äôd)</h2>
<p>In the case of three individual positions, taking into account correlations, the aggregate DEAR is computed as</p>
<p><span class="math display">\[
\text{DEAR (aggregate)} = \sqrt{\text{D}_1^2 + \text{D}_2^2 + \text{D}_3^2 \\
+ 2 \cdot \text{D}_1 \cdot \text{D}_2 \cdot \rho_{12} + 2 \cdot \text{D}_1 \cdot \text{D}_3 \cdot \rho_{13} + 2 \cdot \text{D}_2 \cdot \text{D}_3 \cdot \rho_{23}}
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(\text{D}_1, \text{D}_2, \text{D}_3\)</span> are the DEARs for the three individual positions.</li>
<li><span class="math inline">\(\rho_{12}, \rho_{13}, \rho_{23}\)</span> are the correlation coefficients between the pairs of positions.</li>
</ul>
</section>
<section id="var-portfolio-aggregation-contd-1" class="level2">
<h2 class="anchored" data-anchor-id="var-portfolio-aggregation-contd-1">VaR: portfolio aggregation (cont‚Äôd)</h2>
<p>Suppose we have the following correlation matrix for the daily changes in 7-year rates, changes in euro/dollar spot exchange rates, and changes in equity market returns.</p>
<table class="table">
<colgroup>
<col style="width: 28%">
<col style="width: 16%">
<col style="width: 28%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>7-Year Rates</th>
<th>Euro/Dollar Spot Rates</th>
<th>Equity Market Returns</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>7-Year Rates</td>
<td>1.0</td>
<td>-0.2</td>
<td>0.4</td>
</tr>
<tr class="even">
<td>Euro/Dollar Spot Rates</td>
<td></td>
<td>1.0</td>
<td>0.1</td>
</tr>
<tr class="odd">
<td>Equity Market Returns</td>
<td></td>
<td></td>
<td>1.0</td>
</tr>
</tbody>
</table>
<p>We will use the correlations to compute the aggregate DEAR (VaR).</p>
<p><span class="math display">\[
\begin{aligned}
\text{DEAR (aggregate)} &amp;= \sqrt{\text{D}_1^2 + \text{D}_2^2 + \text{D}_3^2 + 2 \cdot \text{D}_1 \cdot \text{D}_2 \cdot \rho_{12} + 2 \cdot \text{D}_1 \cdot \text{D}_3 \cdot \rho_{13} + 2 \cdot \text{D}_2 \cdot \text{D}_3 \cdot \rho_{23}} \\
&amp;= \sqrt{15207.91^2 + 13164^2 + 46600^2 + 2 \cdot 15207.91 \cdot 13164 \cdot (-0.2)
+ 2 \cdot 15207.91 \cdot 46600 \cdot (0.4) + 2 \cdot 13164 \cdot 46600 \cdot (0.1)} \\
&amp;= 56441.93
\end{aligned}
\]</span></p>
<p>That is, this FI with the three positions in fixed-income securities, FX, and equities has an aggregate DEAR of $56,441.93.</p>
</section>
<section id="var-criticisms-against-riskmetrics" class="level2">
<h2 class="anchored" data-anchor-id="var-criticisms-against-riskmetrics">VaR: criticisms against RiskMetrics</h2>
<p>Obviously, the assumption of all assets‚Äô returns (or changes) follow a normal distribution is not ideal.</p>
<ul>
<li>Some assets‚Äô returns are known to have skewness.</li>
<li>Empirically, asset returns have long tails.</li>
</ul>
<p>Moreover, calculating covariances is practically challenging.</p>
<ul>
<li>With <span class="math inline">\(N\)</span> assets, there are <span class="math inline">\(\frac{N(N-1)}{2}\)</span> covariances to compute.</li>
</ul>
<p><span class="math display">\[
\begin{bmatrix}
\sigma_{1}^2 &amp; \sigma_{12} &amp; \sigma_{13} &amp; \cdots &amp; \sigma_{1N} \\
\sigma_{21} &amp; \sigma_{2}^2 &amp; \sigma_{23} &amp; \cdots &amp; \sigma_{2N} \\
\sigma_{31} &amp; \sigma_{32} &amp; \sigma_{3}^2 &amp; \cdots &amp; \sigma_{3N} \\
\vdots      &amp; \vdots      &amp; \vdots      &amp; \ddots &amp; \vdots      \\
\sigma_{N1} &amp; \sigma_{N2} &amp; \sigma_{N3} &amp; \cdots &amp; \sigma_{N}^2 \\
\end{bmatrix}
\]</span></p>
<ul>
<li>An equity portfolio of 500 stocks suggests a total of 124,750 covariance items.</li>
<li>There are also many more fixed-income securities, etc.</li>
</ul>
</section>
<section id="var-historic-or-back-simulation" class="level2">
<h2 class="anchored" data-anchor-id="var-historic-or-back-simulation">VaR: historic or back simulation</h2>
<p>Many FIs have developed market risk models that employed a historic or back simulation approach.</p>
<p>Essential idea is to revalue current asset portfolio on basis of past actual prices (returns).</p>
<p>Simply put, this approach is to</p>
<ol type="1">
<li>Collect the past 500 days‚Äô actual prices (returns).</li>
<li>Revalue the asset using the 1% worst case, i.e., the portfolio is revalued as the 5th lowest value out of 500.</li>
</ol>
</section>
<section id="var-historic-or-back-simulation-contd" class="level2">
<h2 class="anchored" data-anchor-id="var-historic-or-back-simulation-contd">VaR: historic or back simulation (cont‚Äôd)</h2>
<p>The advantages of historic approach are that</p>
<ol type="1">
<li>it is simple,</li>
<li>it does not require that asset returns be normally distributed, and</li>
<li>it does not require that the correlations or standard deviations of asset returns be calculated.</li>
</ol>
<p>However,</p>
<ol type="1">
<li>500 observations is not very many from a statistical standpoint.</li>
<li>Increasing the number of observations by going back further in time is not desirable.
<ul>
<li>As one goes back further in time, past observations may become decreasingly relevant in predicting VaR in the future.</li>
</ul></li>
</ol>
<p>How to improve?</p>
<ul>
<li>Could weight recent observations more heavily and go further back.</li>
<li>Could generate additional observations (Monte Carlo simulation)!</li>
</ul>
</section>
<section id="var-monte-carlo-simulation" class="level2">
<h2 class="anchored" data-anchor-id="var-monte-carlo-simulation">VaR: Monte Carlo simulation</h2>
<p>The Monte Carlo simulation approach of calculating a portfolio‚Äôs VaR can be summarized as</p>
<ol type="1">
<li><strong>Generate Random Scenarios</strong>:
<ul>
<li>Use statistical methods to simulate a large number of possible future returns for each asset in the portfolio, reflecting their expected returns, volatilities, and correlations.</li>
</ul></li>
<li><strong>Construct Portfolio Returns</strong>:
<ul>
<li>Aggregate the simulated asset returns to calculate the portfolio return for each scenario, considering the weights of each asset in the portfolio.</li>
</ul></li>
<li><strong>Determine VaR</strong>:
<ul>
<li>Analyze the distribution of simulated portfolio returns and identify the threshold loss value that will not be exceeded with a specified confidence level (e.g., 95% or 99%). This threshold is the Value at Risk (VaR).</li>
</ul></li>
</ol>
</section>
<section id="var-monte-carlo-simulation-contd" class="level2">
<h2 class="anchored" data-anchor-id="var-monte-carlo-simulation-contd">VaR: Monte Carlo simulation (cont‚Äôd)</h2>
<p>Suppose we have a portfolio of <span class="math inline">\(N\)</span> assets. Therefore, we have a vector of these assets‚Äô returns <span class="math inline">\(\mu\)</span> and their covariance matrix <span class="math inline">\(\Sigma\)</span>:</p>
<p><span class="math display">\[
\mu = \begin{bmatrix}
\mu_1 \\
\mu_2 \\
\vdots \\
\mu_N
\end{bmatrix}, \quad
\Sigma = \begin{bmatrix}
\sigma_{1}^2 &amp; \sigma_{12} &amp; \cdots &amp; \sigma_{1N} \\
\sigma_{21} &amp; \sigma_{2}^2 &amp; \cdots &amp; \sigma_{2N} \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
\sigma_{N1} &amp; \sigma_{N2} &amp; \cdots &amp; \sigma_{N}^2
\end{bmatrix}
\]</span></p>
<p>We apply <a href="https://en.wikipedia.org/wiki/Cholesky_decomposition">Cholesky Decomposition</a> on the covariance matrix <span class="math inline">\(\Sigma\)</span> to get a lower triangular matrix <span class="math inline">\(L\)</span> and its transpose <span class="math inline">\(L'\)</span>, such that <span class="math display">\[
\Sigma = L L'
\]</span></p>
<p>Next, we generate standard normal random variable, <span class="math inline">\(Z\)</span>, where <span class="math inline">\(M\)</span> is the number of scenarios: <span class="math display">\[
Z = \begin{bmatrix}
z_{11} &amp; z_{12} &amp; \cdots &amp; z_{1N} \\
z_{21} &amp; z_{22} &amp; \cdots &amp; z_{2N} \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
z_{M1} &amp; z_{M2} &amp; \cdots &amp; z_{MN}
\end{bmatrix}
\]</span></p>
<p>The simulated asset returns are given by <span class="math inline">\(\mu + Z L'\)</span></p>
</section>
<section id="var-monte-carlo-simulation-contd-1" class="level2">
<h2 class="anchored" data-anchor-id="var-monte-carlo-simulation-contd-1">VaR: Monte Carlo simulation (cont‚Äôd)</h2>
<p>With the simulated asset returns for <span class="math inline">\(M\)</span> scenarios, we can compute the portfolio return in these <span class="math inline">\(M\)</span> scenarios.</p>
<ul>
<li>This leads to a distribution of potential portfolio returns, which enables the calculation of VaR.</li>
</ul>
</section>
<section id="var-monte-carlo-simulation-example" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="var-monte-carlo-simulation-example">VaR: Monte Carlo simulation (example)</h2>
<div class="columns page-columns page-full">
<div class="column">
<ul>
<li>Number of Assets: 3</li>
<li>Mean Returns
<ul>
<li>Asset 1: 0.10% per period</li>
<li>Asset 2: 0.12% per period</li>
<li>Asset 3: 0.08% per period</li>
</ul></li>
<li>Covariance Matrix <span class="math inline">\(\Sigma\)</span> <span class="math display">\[
\Sigma = \begin{bmatrix}
0.0001 &amp; 0.00002 &amp; 0.000015 \\
0.00002 &amp; 0.0001 &amp; 0.000025 \\
0.000015 &amp; 0.000025 &amp; 0.0001
\end{bmatrix}
\]</span></li>
<li>Portfolio Weights:
<ul>
<li>Asset 1: 40%</li>
<li>Asset 2: 30%</li>
<li>Asset 3: 30%</li>
</ul></li>
<li>Simulation Parameters:
<ul>
<li>Number of Scenarios: 10,000</li>
<li>Confidence Level: 95%</li>
</ul></li>
</ul>
</div><div class="column page-columns page-full">
<div id="cell-fig-returns-monte-carlo" class="cell page-columns page-full" data-fig-location="center" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>n_assets <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>n_scenarios <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>confidence_level <span class="op">=</span> <span class="fl">0.95</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean returns and covariance matrix for the assets</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>mean_returns <span class="op">=</span> np.array([<span class="fl">0.001</span>, <span class="fl">0.0012</span>, <span class="fl">0.0008</span>])  <span class="co"># Example mean returns</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="op">=</span> np.array(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.0001</span>, <span class="fl">0.00002</span>, <span class="fl">0.000015</span>],</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.00002</span>, <span class="fl">0.0001</span>, <span class="fl">0.000025</span>],</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.000015</span>, <span class="fl">0.000025</span>, <span class="fl">0.0001</span>],</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>)  <span class="co"># Example covariance matrix</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Cholesky decomposition of the covariance matrix</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>L <span class="op">=</span> np.linalg.cholesky(cov_matrix)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate standard normal random variables</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>Z <span class="op">=</span> np.random.normal(size<span class="op">=</span>(n_scenarios, n_assets))</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate asset returns</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>simulated_returns <span class="op">=</span> Z <span class="op">@</span> L.T <span class="op">+</span> mean_returns</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Given weights</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>])  <span class="co"># Example weights</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> simulated_returns <span class="op">@</span> weights</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate VaR</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>VaR <span class="op">=</span> np.percentile(portfolio_returns, (<span class="dv">1</span> <span class="op">-</span> confidence_level) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the portfolio returns and VaR</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>plt.hist(portfolio_returns, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, color<span class="op">=</span><span class="st">"#D6D2C4"</span>, edgecolor<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>plt.axvline(VaR, color<span class="op">=</span><span class="st">"#A6192E"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Simulated Portfolio Returns with VaR"</span>)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Portfolio Return"</span>)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"VaR at 95%"</span>, <span class="st">"Portfolio Returns"</span>])</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-returns-monte-carlo" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-returns-monte-carlo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-returns-monte-carlo-output-1.png" width="816" height="523" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-returns-monte-carlo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Distributions of portfolio returns from Monte Carlo simulation
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="expected-shortfall-es" class="level1 page-columns page-full">
<h1>Expected Shortfall (ES)</h1>
<section id="why-var-could-be-misleading" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="why-var-could-be-misleading">Why VaR could be misleading?</h2>
<p>VaR tells the FI manager the loss at a particular point on the probability distribution (i.e., 99th percentile).</p>
<p>It, however, fails to incorporate information regarding the shape of the probability distribution below that particular point.</p>
<div id="cell-fig-returns-same-VaR-different-ES" class="cell page-columns page-full" data-fig-location="center" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>n_scenarios <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>confidence_level <span class="op">=</span> <span class="fl">0.95</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution 1: Normal distribution</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>mu1, sigma1 <span class="op">=</span> <span class="dv">0</span>, <span class="fl">0.01</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>returns1 <span class="op">=</span> np.random.normal(mu1, sigma1, n_scenarios)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>VaR1 <span class="op">=</span> np.percentile(returns1, (<span class="dv">1</span> <span class="op">-</span> confidence_level) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust Distribution 2: Mixture of normal distributions</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>mu2, sigma2 <span class="op">=</span> <span class="fl">0.01</span>, <span class="fl">0.01</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>extreme_mu, extreme_sigma <span class="op">=</span> <span class="op">-</span><span class="fl">0.04</span>, <span class="fl">0.02</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mixture distribution that has the same VaR as Distribution 1</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust the proportion and parameters of the extreme component to match the target VaR</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    extreme_component <span class="op">=</span> np.random.normal(</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        extreme_mu, extreme_sigma, <span class="bu">int</span>(n_scenarios <span class="op">*</span> <span class="fl">0.05</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    normal_component <span class="op">=</span> np.random.normal(mu2, sigma2, <span class="bu">int</span>(n_scenarios <span class="op">*</span> <span class="fl">0.95</span>))</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    returns2 <span class="op">=</span> np.concatenate([extreme_component, normal_component])</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    VaR2 <span class="op">=</span> np.percentile(returns2, (<span class="dv">1</span> <span class="op">-</span> confidence_level) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">abs</span>(VaR2 <span class="op">-</span> VaR1) <span class="op">&lt;</span> <span class="fl">0.0001</span>:</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ES</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>ES1 <span class="op">=</span> np.mean(returns1[returns1 <span class="op">&lt;=</span> VaR1])</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>ES2 <span class="op">=</span> np.mean(returns2[returns2 <span class="op">&lt;=</span> VaR2])</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histograms</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot for Distribution 1</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>plt.hist(returns1, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, color<span class="op">=</span><span class="st">"#D6D2C4"</span>, edgecolor<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>plt.axvline(VaR1, color<span class="op">=</span><span class="st">"#A6192E"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>plt.axvline(ES1, color<span class="op">=</span><span class="st">"green"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution 1 (Normal)"</span>)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Return"</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"VaR at 95%"</span>, <span class="st">"ES"</span>, <span class="st">"Returns"</span>])</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot for Distribution 2</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>plt.hist(returns2, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, color<span class="op">=</span><span class="st">"#D6D2C4"</span>, edgecolor<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>plt.axvline(VaR2, color<span class="op">=</span><span class="st">"#A6192E"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>plt.axvline(ES2, color<span class="op">=</span><span class="st">"green"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution 2 (Mixture)"</span>)</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Return"</span>)</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"VaR at 95%"</span>, <span class="st">"ES"</span>, <span class="st">"Returns"</span>])</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Left: 95% VaR=</span><span class="sc">{</span>VaR1<span class="sc">:.5f}</span><span class="ss">; Right: 95% VaR=</span><span class="sc">{</span>VaR2<span class="sc">:.5f}</span><span class="ss">"</span>)</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Left: Average loss beyond VaR is </span><span class="sc">{</span>ES1<span class="sc">:.5f}</span><span class="ss">"</span>)</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Right: Average loss beyond VaR is </span><span class="sc">{</span>ES2<span class="sc">:.5f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-returns-same-var-different-es" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-returns-same-var-different-es-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-returns-same-var-different-es-output-1.png" width="1331" height="566" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-returns-same-var-different-es-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Distributions with same VaR but different ES
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Left: 95% VaR=-0.01655; Right: 95% VaR=-0.01654
Left: Average loss beyond VaR is -0.02075
Right: Average loss beyond VaR is -0.04258</code></pre>
</div>
</div>
</section>
<section id="es-conditional-var" class="level2">
<h2 class="anchored" data-anchor-id="es-conditional-var">ES: conditional VaR</h2>
<p>The drawbacks of VaR became painfully evident during the financial crisis as asset returns plummeted into the fat-tail region of non-normally shaped distributions.</p>
<p>FI managers and regulators were forced to recognize that VaR projections of possible losses far underestimated actual losses on extreme bad days.</p>
<p>Now, regulators have replaced VaR with the <strong>expected shortfall (ES)</strong> measure as the main measure of market risk.</p>
<p>Expected shortfall, aka ‚Äúconditional VaR‚Äù, estimates the expected value of losses beyond a given confidence level‚Äîthat is, it is the average of VaRs beyond a given confidence level.</p>
</section>
<section id="es-definition" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="es-definition">ES: definition</h2>
<p>For a given confidence level <span class="math inline">\(c\)</span> and a continuous probability distribution, ES can be calculated as <span class="math display">\[
ES(c) = \frac{1}{1-c}\int_c^1 VaR(c)du
\]</span></p>
<p>That is, for a confidence level of, say, 95% (i.e., <span class="math inline">\(c\)</span>), we measure the area under the probability distribution from the 95th to 100th percentile.</p>
<div id="cell-fig-returns-ES" class="cell page-columns page-full" data-fig-location="center" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>n_scenarios <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>confidence_level <span class="op">=</span> <span class="fl">0.95</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust Distribution: Mixture of normal distributions</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>mu2, sigma2 <span class="op">=</span> <span class="dv">0</span>, <span class="fl">0.01</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>extreme_mu, extreme_sigma <span class="op">=</span> <span class="op">-</span><span class="fl">0.05</span>, <span class="fl">0.02</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mixture distribution that has the desired VaR</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>extreme_component <span class="op">=</span> np.random.normal(extreme_mu, extreme_sigma, <span class="bu">int</span>(n_scenarios <span class="op">*</span> <span class="fl">0.1</span>))</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>normal_component <span class="op">=</span> np.random.normal(mu2, sigma2, <span class="bu">int</span>(n_scenarios <span class="op">*</span> <span class="fl">0.9</span>))</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> np.concatenate([extreme_component, normal_component])</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>VaR <span class="op">=</span> np.percentile(returns, (<span class="dv">1</span> <span class="op">-</span> confidence_level) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ES</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>ES <span class="op">=</span> np.mean(returns[returns <span class="op">&lt;=</span> VaR])</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram data</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>n, bins, patches <span class="op">=</span> plt.hist(returns, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, edgecolor<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Highlight bars below VaR</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(patches)):</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bins[i] <span class="op">&lt;</span> VaR:</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        patches[i].set_facecolor(<span class="st">"#A6192E"</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        patches[i].set_facecolor(<span class="st">"#D6D2C4"</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Add VaR and ES lines</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>plt.axvline(VaR, color<span class="op">=</span><span class="st">"#A6192E"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"VaR at 95%"</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>plt.axvline(ES, color<span class="op">=</span><span class="st">"purple"</span>, linestyle<span class="op">=</span><span class="st">"dashed"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"ES"</span>)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Simulated Portfolio Returns with VaR and ES"</span>)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Return"</span>)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-returns-es" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-returns-es-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-returns-es-output-1.png" width="825" height="523" class="figure-img">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-returns-es-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Distribution of expected returns and ES
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="es-advantages-and-potential-problems" class="level2">
<h2 class="anchored" data-anchor-id="es-advantages-and-potential-problems">ES: advantages and (potential) problems</h2>
<p>ES is the average of losses that occur beyond the VaR level. It provides a better risk assessment by considering the tail of the loss distribution.</p>
<p>In addition, an important advantage of ES over VaR is that ES is additive.</p>
<ul>
<li>This means that the ES of a portfolio equals the sum of individual assets‚Äô ESs.</li>
<li>The same does not hold true for VaR: recall that we have to consider covariances.</li>
</ul>
<p>Potential issues with the use of ES include:</p>
<ul>
<li>Estimation challenges, model dependency, computational complexity.</li>
</ul>
</section>
</section>
<section id="bis-regulatory-models" class="level1">
<h1>BIS regulatory models</h1>
<section id="bis-regulatory-models-1" class="level2">
<h2 class="anchored" data-anchor-id="bis-regulatory-models-1">BIS regulatory models</h2>
<p>Two major ways of calculating market risk exposures and capital requirements:</p>
<ul>
<li>The BIS standardized framework</li>
<li>Banks‚Äô internal model approach (IMA), to be approved by regulatory supervisors
<ul>
<li>e.g., RiskMetrics, back simulation, Monte Carlo, etc.</li>
<li>models based on expected shortfall<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></li>
</ul></li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that the ultimate objective of measuring market risk exposure is to determine the appropriate capital requirement.</p>
</div>
</div>
</section>
<section id="basel-iii-and-its-implementation" class="level2">
<h2 class="anchored" data-anchor-id="basel-iii-and-its-implementation">Basel III and its implementation</h2>
<p>With Basel III <em>now</em> being implemented by countries, the market risk measures are shifting from VaR to ES.</p>
<p>The implementation is planned to be phased in over five year since January, 2023.</p>
<p>In UK and US, the implementation is set to be applicable in 2025.</p>
<p>In Australia, APRA is reviewing the currently in force <strong>Prudential Standard APS 116 Capital Adequacy: Market Risk</strong>.</p>
<ul>
<li>As at the time of this lecture, APRA will delay the effective dates of APS 116 from 2025 to 2026.</li>
<li>That is, currently, Australian banks using IMA measure market risks based on VaR.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Globally, banks are in need of talents with specialized knowledge in the field!</p>
</div>
</div>
</section>
<section id="regulatory-model-standardized-framework" class="level2">
<h2 class="anchored" data-anchor-id="regulatory-model-standardized-framework">Regulatory model: standardized framework</h2>
<p>The standardized framework is primarily designed for (smaller) banks that do not use internal models.</p>
<ul>
<li>Calculation is more formulaic and prescriptive, focusing on specific risk weights and capital charges for different types of assets and market risks.</li>
</ul>
<p>The standardized approach capital requirement is the simple sum of three components:</p>
<ol type="1">
<li>the capital requirement under the sensitivities-based method,</li>
<li>the default risk capital (DRC) requirement, and</li>
<li>the residual risk add-on (RRAO).</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For a detailed description, see MAR21, MAR22, and MAR23 in <a href="https://www.bis.org/bcbs/publ/d457.pdf">BIS Minimum capital requirements for market risk</a>.</p>
</div>
</div>
</section>
<section id="regulatory-model-ima" class="level2">
<h2 class="anchored" data-anchor-id="regulatory-model-ima">Regulatory model: IMA</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Banks‚Äô IMA for market risk currently is based on VaR, but very soon (in the coming years) will be based on ES. Therefore, only the proposed ES-based IMA will be briefly explained here.</p>
</div>
</div>
<p>General steps:</p>
<ol type="1">
<li>Calculation of expected shortfall</li>
<li>Calculation of capital requirement for modellable risk factors</li>
<li>Calculation of capital requirement for non-modellable risk factors</li>
<li>Calculation of default risk capital requirement</li>
<li>Calculation of capital requirement for model-ineligible trading desks</li>
<li>Aggregation of capital requirement</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For a detailed description, see MAR33 in <a href="https://www.bis.org/bcbs/publ/d457.pdf">BIS Minimum capital requirements for market risk</a>.</p>
</div>
</div>
</section>
</section>
<section id="finally" class="level1">
<h1>Finally‚Ä¶</h1>
<section id="suggested-readings" class="level2">
<h2 class="anchored" data-anchor-id="suggested-readings">Suggested readings</h2>
<ul>
<li><a href="https://www.bis.org/bcbs/publ/d457_inbrief.pdf">BIS The market risk framework in brief</a></li>
<li><a href="https://www.bis.org/bcbs/publ/d457.pdf">BIS Minimum capital requirements for market risk</a></li>
<li><a href="https://www.apra.gov.au/sites/default/files/141120-APS-116_0.pdf">APRA Prudential Standard APS 116 Capital Adequacy: Market Risk</a></li>
<li><a href="https://www.apra.gov.au/information-paper-apra%E2%80%99s-policy-priorities">APRA‚Äôs Policy Priorities</a></li>
<li><a href="https://www.bankofengland.co.uk/prudential-regulation/publication/2022/november/implementation-of-the-basel-3-1-standards/market-risk">Bank of England Implementation of the Basel 3.1 standards: Market risk</a></li>
</ul>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>


</section>
</section>


<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Derivatives are off-balance-sheet.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>In other words, we set a confidence level of 99%.<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn3"><p>These come from some sophisticated estimations.<a href="#fnref3" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn4"><p>In Basel III, market risk measurement is shifted from VaR to ES. However, its implementation varies across countries.<a href="#fnref4" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/mingze-gao\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright ¬© 2019 - 2024 Mingze Gao</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mgao6767">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/AdrianMingzeGao">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/adriangao/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:mingze.gao@mq.edu.au">
      <i class="bi bi-send" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>